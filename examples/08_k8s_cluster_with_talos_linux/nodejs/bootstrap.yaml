apiVersion: batch/v1
kind: Job
metadata:
  name: talos-bootstrapper
  namespace: kube-system
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        name: talos-bootstrapper
    spec:
      containers:
        - name: bootstrapper
          image: bitnami/kubectl
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CONFIG
              value: '{"host":"postgresql.example.svc","secretKeyRef":{"key":"invalid","name":"invalid"},"user":"postgres"}'
            - name: ACTION
              value: '{"authorise_ns_user":false,"create_databases":["dummy"]}'
          command:
            - bash
          args:
            - /jobs/database.sh
      restartPolicy: OnFailure
  backoffLimit: 10
